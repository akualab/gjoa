package model

import (
	"encoding/json"
	"github.com/golang/glog"
	"io"
	"math/rand"
	"os"
)

// Returns a random observations generated by the model.
// obs is the random observation.
// sequence applies to Markov models.
type Generator interface {
	Random(r *rand.Rand) (obs interface{}, sequence []int, e error)
}

// A read-only model.
type Modeler interface {
	Prob(obs interface{}) float64
	LogProb(obs interface{}) float64
	Name() string
	//String() string
	NumElements() int
	Trainable() bool
	Write(w io.Writer) error
	Values() interface{}
	Generator
}

// A trainable model.
type Trainer interface {
	Modeler

	Update(a []float64, w float64) error
	Estimate() error
	Clear() error
	SetName(name string)
	NumSamples() float64
}

// A trainable sequence model.
type SequenceTrainer interface {
	Modeler

	Update(seq [][]float64, w float64) error
	Estimate() error
	Clear() error
	SetName(name string)
	NumSamples() float64
}

// Implements basic functionality for models. Model implementations can embed
// this type. The field Base.Model must be initialized to point to the model
// implementation.
type Base struct {
	Model Modeler
}

func (base *Base) Write(w io.Writer) error {

	b, err := json.Marshal(base.Model.Values())
	if err != nil {
		glog.Fatal(err)
	}
	_, e := w.Write(b)
	return e
}

func (base *Base) WriteToFile(fn string) error {

	f, err := os.Create(fn)
	if err != nil {
		return err
	}
	defer f.Close()

	ee := base.Write(f)
	if ee != nil {
		return ee
	}

	glog.Infof("Wrote model \"%s\" to file %s.", base.Model.Name(), fn)
	return nil
}
